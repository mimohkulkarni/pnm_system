<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Manage Requests</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
    <link href="/css/style.css" rel="stylesheet" type="text/css">
    <link href="/css/request.css" rel="stylesheet" type="text/css">
</head>
<body>
    <%- include('./components/navbar') -%>
    <div class="container-fluid">
        <div class="table-responsive">
            <% if (params.add) { %>
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                  <strong>Request created successfully</strong>
                  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>      
            <% } %>
            <% if (params.meeting) { %>
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                  <strong>Meeting created successfully</strong>
                  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>      
            <% } %>
            <% if (params.edit) { %>
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                  <strong>Request edited successfully</strong>
                  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>      
              <% } %>
            <div class="table-wrapper">
                <div class="table-title">
                    <div class="row w-100">
                        <div class="col-sm-6">
                            <h2>Manage <b>Requests</b></h2>
                        </div>
                        <div class="col-sm-6 text-right">
                            <% if (params.user_level === 5) { %>
                                <a href="/requests/add" class="btn btn-success">
                                    <i class="fas fa-plus"></i> <span>Add New Request</span>
                                </a>
                            <% } %>
                            <% if (params.user_level === 1) { %>
                                <button class="btn btn-success" id="btn_create_meeting" data-toggle="modal" data-target="#meeting_modal">
                                    <i class="fas fa-plus"></i> <span>Create New Meeting</span>
                                </button>
                            <% } %>
                        </div>
                    </div>
                </div>                
                <% if(params.requests.length > 0) { %>
                <div class="w-100 text-right mb-3">
                    <button class="btn btn-success" id="btnSend">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th class="titleTh">Title</th>
                            <th class="descTh">Description</th>
                            <th>Created By</th>
                            <th>Created On</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% params.requests.forEach(request => { %>
                            <tr>
                                <td><%= request.title %></td>
                                <td><%= request.description.length > 50 ? request.description.substring(0,50) + "..." : request.description %></td>
                                <td><%= request.created_by %></td>
                                <td><%= request.created_at %></td>
                                <td><%= request.status %></td>
                                <td>
                                    <% if (params.user_level === 5 && !request.approved) { %>
                                        <a href="/requests/edit/<%= request.id %>" class="edit">
                                            <i class="far fa-edit" data-toggle="tooltip" title="Edit"></i>
                                        </a>
                                        <a href="/requests/delete/<%= request.id %>" class="delete"  onclick="return confirm('Do you want to delete this request?')">
                                            <i class="far fa-trash-alt" data-toggle="tooltip" title="Delete"></i>
                                        </a>
                                    <% } %>
                                    <a href="/requests/view/<%= request.id %>" class="view">
                                        <i class="fas fa-info"></i>
                                    </a>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
                <% } else { %>
                    <h5 class="text-center font-weight-bold">No Requests Found!</h5>
                <% } %>
            </div>
        </div>
        <% if (params.user_level === 1) { %>
            <div class="modal" tabindex="-1" id="meeting_modal">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <form action="/requests/createMeeting" method="post">
                            <div class="modal-header">
                                <h5 class="modal-title">Create New Meeting</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-6 text-black">
                                        <h6>Select Meeting Date</h6>
                                    </div>
                                    <div class="col-6 px-2">
                                        <input type="date" class="form-control" name="meeting_date" />
                                    </div>
                                    <div class="col-6 text-black mt-3">
                                        <h6>Meeting Name</h6>
                                    </div>
                                    <div class="col-6 px-2 mt-3">
                                        <input type="text" class="form-control" name="meeting_name" />
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-success">Create</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        <% } %>
    </div>
    <script>
        $(document).ready(function(){
            const category_ids = <%- params.requests.length > 0 ? JSON.stringify(params.requests.map(r => r.category_id)) : "null" %>;
            $('[data-toggle="tooltip"]').tooltip();
            $("#btnSend").hide();
            const multiselect = $('.multiselect');
            let i = 0;
            multiselect.each(function(){
                $(this).selectpicker('val',category_ids[i]);
                i++;
            });
            
            const checkbox = $('table tbody input[type="checkbox"]');
            $("#selectAll").click(function(){
                const selectAllChecked = this.checked
                checkbox.each(function(){
                    this.checked = selectAllChecked;
                });
                if(this.checked) $("#btnSend").show();
                else $("#btnSend").hide();
            });
            checkbox.click(function(){
                if(!this.checked && $("#selectAll").prop("checked")){
                    $("#selectAll").prop("checked", false);
                    $("#btnSend").hide();
                }
                let showSendBtn = false;
                checkbox.each(function(){
                    showSendBtn = showSendBtn || this.checked;
                }); 
                if(showSendBtn) $("#btnSend").show();
                if(!showSendBtn) $("#btnSend").hide();
            });
            const user_level = <%- params.user_level ? JSON.stringify(params.user_level) : "null" %>;
            $("#btnSend").on("click", function(){
                if([1,2].includes(user_level)){
                    const ids = [];
                    const categories = [];
                    checkbox.each(function(){
                        if(this.checked){
                            const id = parseInt($(this).val());
                            ids.push(id);
                            categories.push($(`#category${id}`).selectpicker('val'))
                        }
                    });
                    const form = $('<form method="post"></form>').prop("action", user_level == 1 ? "/requests/setCategory" : "/requests/setApproval");
                    $("<input>").attr("type", "hidden").attr("name", "id").val(JSON.stringify(ids)).append(form);
                    $("<input>").attr("type", "hidden").attr("name", "categories").val(JSON.stringify(categories)).append(form);
                    // form.appendTo('body').submit();
                }
            });
            $("#btn_create_meeting").on("click", function(){

            });
        });
    </script>
</body>
</html>