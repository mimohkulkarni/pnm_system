<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Manage Requests</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
    <link href="/css/style.css" rel="stylesheet" type="text/css">
    <link href="/css/request.css" rel="stylesheet" type="text/css">
</head>
<body>
    <%- include('./components/navbar', {page: 'requests', user_level: params.user_level ? params.user_level : null}); %>
    <div class="container-fluid">
        <div class="table-responsive">
            <% if (params.add) { %>
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                  <strong>Request created successfully</strong>
                  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>      
            <% } %>
            <% if (params.meeting) { %>
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                  <strong>Meeting created successfully</strong>
                  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>      
            <% } %>
            <% if (params.edit) { %>
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                  <strong>Request edited successfully</strong>
                  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>      
              <% } %>
            <div class="table-wrapper">
                <div class="table-title">
                    <div class="row w-100">
                        <div class="col-sm-6">
                            <h2>Manage <b>Requests</b></h2>
                        </div>
                        <div class="col-sm-6 text-right">
                            <% if (params.user_level === 5) { %>
                                <a href="/requests/add" class="btn btn-success">
                                    <i class="fas fa-plus"></i> <span>Add New Request</span>
                                </a>
                            <% } %>
                        </div>
                    </div>
                </div>
                <% if(params.requests.length > 0) { %>
                    <!-- <div class="w-100 text-right mb-3">
                        <button class="btn btn-success" id="btnSend">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div> -->
                    <div class="row mb-3">
                        <div class="<%- params.user_level === 1 ? 'col-3' : 'col-6' %>">
                        </div>
                        <% if (params.user_level === 1) { %>
                            <div class="col-lg-3 col-md-3 col-sm-3">
                                <div class="request-card">
                                    <b>Union Type</b>
                                    <select class="form-control" id="unionSelect">
                                        <option value="0">All</option>
                                        <option value="1">NRMU</option>
                                        <option value="2">CRMS</option>
                                    </select>
                                </div>
                            </div>
                        <% } %>
                        <div class="col-lg-3 col-md-3 col-sm-3">
                            <div class="request-card">
                                <b>Meeting</b>
                                <select class="form-control" id="meetingSelect">
                                    <option value="0">All</option>
                                    <% params.meetings.forEach(meeting => { %>
                                        <option value="<%= meeting.id %>"><%= meeting.name %></option>
                                    <% }) %>
                                </select>
                             </div>
                        </div>
                        <div class="col-lg-3 col-md-3 col-sm-3">
                            <div class="request-card">
                                <b>Request Type</b>
                                <select class="form-control" id="typeSelect">
                                    <option value="0">All</option>
                                    <option value="1">Open</option>
                                    <option value="2">Closed</option>
                                </select>
                             </div>
                        </div>
                    </div>
                    <table class="table table-striped table-hover" id="requestsTable">
                    </table>
                <% } else { %>
                    <h5 class="text-center font-weight-bold">No Requests Found!</h5>
                <% } %>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function(){
            const requests = <%- params.requests.length > 0 ? JSON.stringify(params.requests) : [] %>;
            const user_level = <%- parseInt(params.user_level) %>;
            const category_ids = <%- params.requests.length > 0 ? JSON.stringify(params.requests.map(r => r.category_id)) : "null" %>;
            $('[data-toggle="tooltip"]').tooltip();
            $("#btnSend").hide();
            const multiselect = $('.multiselect');
            let i = 0;
            multiselect.each(function(){
                $(this).selectpicker('val',category_ids[i]);
                i++;
            });
            
            const checkbox = $('table tbody input[type="checkbox"]');
            $("#selectAll").click(function(){
                const selectAllChecked = this.checked
                checkbox.each(function(){
                    this.checked = selectAllChecked;
                });
                if(this.checked) $("#btnSend").show();
                else $("#btnSend").hide();
            });
            checkbox.click(function(){
                if(!this.checked && $("#selectAll").prop("checked")){
                    $("#selectAll").prop("checked", false);
                    $("#btnSend").hide();
                }
                let showSendBtn = false;
                checkbox.each(function(){
                    showSendBtn = showSendBtn || this.checked;
                }); 
                if(showSendBtn) $("#btnSend").show();
                if(!showSendBtn) $("#btnSend").hide();
            });
            $("#btnSend").on("click", function(){
                if([1,2].includes(user_level)){
                    const ids = [];
                    const categories = [];
                    checkbox.each(function(){
                        if(this.checked){
                            const id = parseInt($(this).val());
                            ids.push(id);
                            categories.push($(`#category${id}`).selectpicker('val'))
                        }
                    });
                    const form = $('<form method="post"></form>').prop("action", user_level == 1 ? "/requests/setCategory" : "/requests/setApproval");
                    $("<input>").attr("type", "hidden").attr("name", "id").val(JSON.stringify(ids)).append(form);
                    $("<input>").attr("type", "hidden").attr("name", "categories").val(JSON.stringify(categories)).append(form);
                    // form.appendTo('body').submit();
                }
            });
            
            const thead = `<thead><tr><th class="titleTh">Title</th><th class="descTh">Description</th><th>Created By</th>
                <th>Created On</th><th>Status</th><th>Actions</th></tr></thead>`
            
            $("#unionSelect,#typeSelect,#meetingSelect").on("change", () => displayRequests());

            displayRequests();

            function displayRequests(){
                const union = parseInt($("#unionSelect").val());
                const type = parseInt($("#typeSelect").val());
                const meeting = parseInt($("#meetingSelect").val());
                let filteredRequests = [...requests];
                if(union)
                    filteredRequests = filteredRequests.filter(re => re.union_id === union);
                if(type)
                    filteredRequests = filteredRequests.filter(re => (type === 1 && re.open === 1) || (type === 2 && !re.open));
                if(meeting)
                    filteredRequests = filteredRequests.filter(re => re.meeting_id === meeting);
                $("#requestsTable").empty();
                if(filteredRequests.length > 0){
                    $("#requestsTable").append(thead);
                    filteredRequests.forEach(request => {
                        $("#requestsTable").append(`
                            <tr>
                                <td>${request.title}</td>
                                <td>${request.description.length > 50 ? request.description.substring(0,50) + "..." : request.description}</td>
                                <td>${request.created_by}</td>
                                <td>${request.created_at}</td>
                                <td>${request.status}</td>
                                <td>
                                    ${user_level === 5 && !request.approved ? 
                                        `<a href="/requests/edit/${request.id}" class="edit">
                                            <i class="far fa-edit" data-toggle="tooltip" title="Edit"></i>
                                        </a>`
                                    : ""}
                                    ${user_level === 5 && !request.approved ? 
                                        `<a href="/requests/delete/${request.id}" class="delete" onclick="return confirm('Do you want to delete this request?')">
                                            <i class="far fa-trash-alt" data-toggle="tooltip" title="Delete"></i>
                                        </a>`
                                    : ""}
                                    <a href="/requests/view/${request.id}" class="view">
                                        <i class="fas fa-info"></i>
                                    </a>
                                </td>
                            </tr>
                        `);    
                    });
                }
                else $("#requestsTable").append(`<h5 class="text-center font-weight-bold">No Requests Found!</h5>`);
            }
        });
    </script>
</body>
</html>