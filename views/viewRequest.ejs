<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>View Request</title>
   <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
   <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
   <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
   <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
   <link href="/css/style.css" rel="stylesheet" type="text/css">
   <link href="/css/addRequest.css" rel="stylesheet" type="text/css">
</head>
<body>
   <section class="get-in-touch">
      <h2 class="text-center py-2" style="border-bottom: 1px solid darkgray;"><%= params.title %></h2>
      <div class="px-3">
         <div class="row">
            <b class="col-3">Description</b>
            <p class="col-9" style="word-break: break-all;"><%= params.description %></p>
            <b class="col-3">Created At</b>
            <p class="col-9" style="word-break: break-all;"><%= params.created_at  %></p>
            <b class="col-3">Created By</b>
            <p class="col-9" style="word-break: break-all;"><%= params.created_by %></p>
            <b class="col-3">Meeting Name</b>
            <p class="col-9" style="word-break: break-all;"><%= params.meeting_name %></p>
            <% if (params.category_names.length > 0) { %> 
               <b class="col-3">Department Name</b>
               <p class="col-9" style="word-break: break-all;"><%= params.category_names.join(", ") %></p>
               <b class="col-3">Department Set By</b>
               <p class="col-9" style="word-break: break-all;"><%= params.category_set_by %></p>
            <% } if([1,2].includes(params.user_level) && !params.approved && params.level_3_remarks.length === 0 && params.level_4_remarks.length === 0) { %>
               <b class="col-3 my-2"><%- params.category_names ? "Change Department" : "Department" %></b>
               <div class="col-9 my-2">
               <select class="selectpicker" multiple name="category" id="category">
                  <% params.categories.forEach(category => { %>
                     <option value="<%= category.id %>" <%- params.category_ids.includes(category.id) ? "selected" : "" %>><%= category.name %></option>
                  <% }) %>
               </select>
               </div>
            <% } %>
            <b class="col-3 my-4">Status</b>
            <p class="col-9 my-4" style="word-break: break-all;">
               <%- params.open === 0 ? "Closed" : params.category_names.length > 0 && params.approved ? "Sent to Departmental Review" : params.category_names.length > 0 && !params.approved ? "Sent for Department Approval" : params.level_3_remarks.length > 0 || params.level_4_remarks.length > 0 ? "Remarked" : "Open" %>
            </p>
            <% if (params.open === 0) { %> 
               <b class="col-3">Closed At</b>
               <p class="col-9" style="word-break: break-all;"><%= params.closed_at %></p>
               <b class="col-3">Closed By</b>
               <p class="col-9" style="word-break: break-all;"><%= params.closed_by %></p>
            <% } %>
            <!-- level 2 -->
            <% if(params.level_2_remarks.length > 0) { %> 
               <b class="col-3">DPO Remarks</b>
               <div class="col-9" style="word-break: break-all;">
                  <% params.level_2_remarks.forEach(remark => { %>
                     <p style="word-break: break-all;"><%= remark.remark %></p>
                  <% }); %>
               </div>
            <% } %>
            <!-- level 3 -->
            <% if(params.level_3_remarks.length > 0) { %> 
               <b class="col-3">BO Remarks</b>                  
               <div class="col-9" style="word-break: break-all;">
                  <% params.level_3_remarks.forEach(remark => { %>
                     <p style="word-break: break-all;"><%= remark.remark %></p>
                  <% }); %>
               </div>
            <% } %>
            <!-- level 4 -->
            <% if(params.level_4_remarks.length > 0) { %> 
               <b class="col-3">OS Remarks</b>
               <div class="col-9" style="word-break: break-all;">
                  <% params.level_4_remarks.forEach(remark => { %>
                     <p style="word-break: break-all;"><%= remark.remark %></p>
                  <% }); %>
               </div>
            <% } %>               
            <% if ([2,3,4].includes(params.user_level)) { %>
               <b class="col-3">Remarks</b>
               <div class="col-9">
                  <textarea id="remarks" class="form-control" placeholder="Enter remarks" required></textarea>
               </div>
            <% } %>
            <div class="col-12" id="remarksErrorDiv" style="display: none;">
               <div class="alert alert-danger mt-2 w-100" role="alert">
                  <strong>Please enter valid remarks.</strong>
                  </div>
            </div>
            <% if (params.queryError) { %>
               <div class="col-12">
                  <div class="alert alert-danger mt-2 w-100" role="alert">
                     <strong>Opps! Some error occured! Please try again with valid entries or try in some time.</strong>
                     </div>
               </div>
            <% } %> 
            <% if (params.closed) { %>
               <div class="col-12">
                  <div class="alert alert-success mt-2 w-100" role="alert">
                     <strong>This request has been already closed!</strong>
                     </div>
               </div>
            <% } %> 
            
            <% if(!params.closed && ((!params.approved && params.user_level === 1) || (!params.approved && params.user_level === 2) || (params.approved && params.category_names && [3,4].includes(params.user_level)))) { %>
               <div class="w-100 text-right px-3 mt-3" id="btn_div">
                  <button class="btn btn-danger" data-type="1" type="button" id="btn_reject" style="display: none;">
                     Reject
                  </button>
                  <button class="btn btn-warning" data-type="2" type="button" id="btn_forward" style="display: none;">
                     Forward
                  </button>
                  <button class="btn btn-success" data-type="3" type="button" id="btn_submit">
                     Submit
                  </button>
               </div>
            <% } %>
            <% if(params.user_level === 1) { %>
               <div class="w-100 text-right px-3 mt-3">
                  <button class="btn btn-warning" type="button" data-toggle="modal" data-target="#meeting_modal">
                     Forward to next meeting
                  </button>
                  <% if(params.level_3_remarks.length > 0 && !params.forwarded && params.approved) { %>
                     <button class="btn btn-success" type="button" id="btn_close">
                        Close Request
                     </button>
                  <% } %>
               </div>
            <% } %>
         </div>
      </div>
      <% if (params.user_level === 1) { %>
         <div class="modal" tabindex="-1" id="meeting_modal">
             <div class="modal-dialog modal-lg">
                 <div class="modal-content">
                     <form action="/requests/createMeeting" method="post">
                         <div class="modal-header">
                             <h5 class="modal-title">Forward Request To Next Meeting</h5>
                             <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                 <span aria-hidden="true">&times;</span>
                             </button>
                         </div>
                         <div class="modal-body">
                           <div class="form-field">
                              <select id="meeting_id" class="form-control">
                                 <option selected>Select Meeting</option>
                                 <% params.meetings.forEach(meeting => { %>
                                    <option value="<%= meeting.id %>"><%= meeting.name %></option>
                                 <% }) %>
                              </select>
                           </div>
                         </div>
                         <div class="modal-footer">
                             <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                             <button type="button" class="btn btn-warning" id="btn_forward_meet">Forward</button>
                         </div>
                     </form>
                 </div>
             </div>
         </div>
     <% } %>
   </section>
   <script>
      const category_names = <%- params.category_names.length > 0 ? JSON.stringify(params.category_names) : "null" %>;
      const user_level = <%- parseInt(params.user_level) %>;
      const approved = <%- parseInt(params.user_level) === 0 %>; 
      const req_id = <%- parseInt(params.id) %>;
      const remarksError = <%- params.remarksError ? params.remarksError : "null" %>;

      if(remarksError) $("#remarksErrorDiv").show();

      if(!approved && user_level === 1) $("#btn_div").show();
      else if(!approved && !category_names && user_level === 1) $("#btn_div").hide();
      else if(!approved && category_names.length > 0 && user_level === 2){
         $("#btn_div").show();
         $("#btn_submit").text("Approve");
         $("#btn_reject").show();
      } 
      else if(!approved && category_names && [3,4].includes(user_level)){
         $("#btn_div").show();
         $("#btn_submit").text("Mark For Close");
         if(user_level === 3) $("#btn_forward").show();
      } 
      else $("#btn_div").remove();

      $("#btn_reject,#btn_submit").click(function() {
         const form = $('<form method="post"></form>').prop("action", user_level === 1 ? '/requests/setCategory' : user_level === 2 ? '/requests/setApproval' : "/requests/addRemarks");
         if([1,2].includes(user_level)){
            form.append($("<input>").attr("type", "hidden").attr("name", "ids").val(JSON.stringify([req_id])));
            form.append($("<input>").attr("type", "hidden").attr("name", "categories").val(JSON.stringify([$("#category").selectpicker('val')])));
            form.append($("<input>").attr("type", "hidden").attr("name", "remarks").val($("#remarks").val()));
            if(user_level === 2)
               form.append($("<input>").attr("type", "hidden").attr("name", "approval").val(parseInt($(this).data("type"))));
         }
         else{
            form.append($("<input>").attr("type", "hidden").attr("name", "remarks").val($("#remarks").val()));
            form.append($("<input>").attr("type", "hidden").attr("name", "id").val(req_id));
         }
         if([3,4].includes(user_level) && !$("#remarks").val()){
            $("#remarksErrorDiv").show();
            return;
         }
         form.appendTo('body').submit();
      });
      
      $("#btn_forward").click(function() {
         const remarks = $("#remarks").val();
         if(user_level === 3 && remarks){
            const form = $('<form method="post"></form>').prop("action", "/requests/forward");
            form.append($("<input>").attr("type", "hidden").attr("name", "id").val(req_id));
            form.append($("<input>").attr("type", "hidden").attr("name", "remarks").val($("#remarks").val()));
            form.appendTo('body').submit();
         }
         else $("#remarksErrorDiv").show();
      });

      $("#btn_close").click(function() {
         if(user_level === 1){
            const form = $('<form method="post"></form>').prop("action", "/requests/close");
            form.append($("<input>").attr("type", "hidden").attr("name", "id").val(req_id));
            form.appendTo('body').submit();
         }
      });

      $("#btn_forward_meet").click(function() {
         const meeting_id = parseInt($("$meeting_id").val());
         if(user_level === 1 && meeting_id){
            const form = $('<form method="post"></form>').prop("action", "/requests/forwardToNextMeeting");
            form.append($("<input>").attr("type", "hidden").attr("name", "id").val(req_id));
            form.append($("<input>").attr("type", "hidden").attr("name", "meeting_id").val(meeting_id));
            form.appendTo('body').submit();
         }
      });

      $('#category').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
         if($(this).selectpicker("val").length > 0) $("#btn_div").show();
         else $("#btn_div").hide();
      });
   </script>
</body>
</html>

